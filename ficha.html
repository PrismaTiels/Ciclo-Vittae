<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ciclo Vitae - Ficha Final v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050507;
            --panel-bg: #0a0a0f;
            --accent: #8b5cf6;
            --accent-rgb: 139, 92, 246;
            --text-muted: #71717a;
        }

        /* TEMA DIN√ÇMICO */
        .tema-vivo { --accent: #8b5cf6; --accent-rgb: 139, 92, 246; }
        .tema-morto { --accent: #10b981; --accent-rgb: 16, 185, 129; }

        body { background-color: var(--bg-color); color: #e4e4e7; font-family: 'Inter', sans-serif; min-height: 100vh; margin: 0; display: flex; overflow: hidden; }
        .font-title { font-family: 'Outfit', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .sidebar { 
            width: 380px; background: var(--panel-bg); border-right: 1px solid rgba(255, 255, 255, 0.05); 
            height: 100vh; position: sticky; top: 0; padding: 30px; overflow-y: auto; flex-shrink: 0;
            display: flex; flex-direction: column; gap: 2rem;
        }

        .input-glass {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            color: white; border-radius: 6px; padding: 8px; outline: none; transition: 0.3s;
        }
        .input-glass:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.2); }

        /* BARRAS DE PROGRESSO */
        .progress-container { display: flex; flex-direction: column; gap: 4px; }
        .progress-bg { background: rgba(0,0,0,0.4); height: 28px; border-radius: 6px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); position: relative; }
        .progress-fill { height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .progress-text { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: 700; text-shadow: 0 1px 2px black; z-index: 2; pointer-events: none; }
        .progress-inputs { position: absolute; inset: 0; display: flex; justify-content: space-between; opacity: 0; transition: 0.2s; z-index: 3; }
        .progress-bg:hover .progress-inputs { opacity: 1; }
        .bar-btn { 
            width: 32px; 
            height: 100%; 
            border: none; 
            background: rgba(0,0,0,0.6); 
            color: white; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 9px;
            transition: 0.2s;
        }
        .bar-btn:hover { background: var(--accent); color: black; }
        
        /* Esconde as setinhas padr√£o do navegador */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Estilo dos mini-bot√µes de controle */
        .ctrl-btn {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 3px;
            color: var(--accent);
            font-size: 10px;
            cursor: pointer;
            transition: 0.2s;
        }
        .ctrl-btn:hover {
            background: var(--accent);
            color: black;
            box-shadow: 0 0 8px var(--accent);
        }

        /* TABS */
        .tabs-nav { display: flex; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tab-btn { padding: 20px 30px; cursor: pointer; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); transition: 0.3s; border-bottom: 2px solid transparent; }
        .tab-active { color: white; border-bottom-color: var(--accent); background: linear-gradient(to top, rgba(var(--accent-rgb), 0.05), transparent); }

        main { flex-grow: 1; height: 100vh; overflow-y: auto; background-image: radial-gradient(circle at 50% 0%, rgba(var(--accent-rgb), 0.08), transparent 70%); }
        .content-area { padding: 40px; max-width: 1200px; margin: 0 auto; }

        .skills-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .skill-card {
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px; padding: 12px; display: flex; flex-direction: column; gap: 8px;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .skill-card:hover { transform: translateY(-2px); border-color: var(--accent); background: rgba(var(--accent-rgb), 0.05); }
        .skill-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .skill-name { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .skill-attr { font-size: 9px; opacity: 0.4; font-weight: 600; margin-top: 2px; }
        .skill-val { font-size: 18px; font-family: 'JetBrains Mono'; font-weight: 700; color: var(--accent); }
        
        .btn-roll { 
            flex-grow: 1; background: var(--accent); color: #000; border: none; border-radius: 4px; 
            padding: 4px; font-size: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase;
            transition: 0.2s;
        }
        .btn-roll:hover { filter: brightness(1.2); box-shadow: 0 0 10px var(--accent); }

        .item-list { display: flex; flex-direction: column; gap: 8px; }
        .item-row { 
            display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: center;
            background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);
        }
        .combat-row { grid-template-columns: 2fr 1fr 1fr auto auto; }
        
        .btn-icon { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #ef4444; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: #ef4444; color: white; }
        .btn-add { width: 100%; padding: 10px; border: 1px dashed rgba(255,255,255,0.2); background: transparent; color: rgba(255,255,255,0.5); cursor: pointer; border-radius: 8px; margin-top: 10px; }
        .btn-add:hover { border-color: var(--accent); color: var(--accent); background: rgba(var(--accent-rgb), 0.05); }

        #pop-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; z-index: 999; }
        .pop-card { 
            width: 260px; background: #0e0e12; border-left: 3px solid var(--accent); border-radius: 6px; 
            padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); pointer-events: auto;
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); position: relative;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .crit-gold { color: #f59e0b; text-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }
        .crit-blue { color: #3b82f6; text-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
        
        .hidden { display: none !important; }
        .text-overload { color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }

        select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 12px;
    padding-right: 28px !important;
    cursor: pointer;
}

select option {
    background: #1a1a1f;
    color: white;
    padding: 10px;
}

/* Cart√µes de Habilidade */
.hab-card {
    background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 16px;
    transition: 0.3s;
}
.hab-card:hover { border-color: var(--accent); }

    </style>
</head>
<body class="tema-vivo" id="body-tag">

<div id="pop-container"></div>

<aside class="sidebar">
    <div>
        <div class="flex justify-between items-end mb-2">
            <h1 id="char-name-display" class="text-3xl font-title font-bold text-white uppercase italic tracking-tighter leading-none">...</h1>
            <span id="char-state-display" class="text-[9px] bg-white/10 px-2 py-1 rounded text-white font-mono uppercase">VIVO</span>
        </div>
        <button onclick="toggleEstado()" class="text-[9px] w-full text-center text-white/30 hover:text-[var(--accent)] transition uppercase tracking-widest border-t border-white/5 pt-2">Alterar Estado Vital</button>
    </div>

<div class="space-y-3">
    <div class="flex gap-2">
        <div class="flex-[2]">
            <label class="text-[9px] uppercase tracking-widest text-white/40 font-bold">Nome</label>
            <input id="inp-nome" onchange="saveInfo('nome', this.value)" class="input-glass w-full text-sm font-bold" placeholder="Nome do Personagem">
        </div>
        <div class="flex-1">
            <label class="text-[9px] uppercase tracking-widest text-white/40 font-bold">Profiss√£o</label>
            <input id="inp-profissao" onchange="saveInfo('profissao', this.value)" class="input-glass w-full text-sm font-bold" placeholder="Ex: Detetive">
        </div>
    </div>
    <div class="flex gap-2">
        <div class="flex-1">
            <label class="text-[9px] uppercase tracking-widest text-white/40 font-bold">Idade</label>
            <input id="inp-idade" onchange="saveInfo('idade', this.value)" class="input-glass w-full text-sm text-center">
        </div>
        <div class="flex-1">
            <label class="text-[9px] uppercase tracking-widest text-white/40 font-bold">Altura</label>
            <input id="inp-altura" onchange="saveInfo('altura', this.value)" class="input-glass w-full text-sm text-center">
        </div>
    </div>
</div>

    <div id="bars-container" class="space-y-4"></div>

    <div>
        <h3 class="text-[10px] uppercase tracking-[0.3em] font-black text-white/20 mb-3 border-b border-white/5 pb-2">Atributos</h3>
        <div id="attrs-list" class="space-y-2"></div>
    </div>
</aside>

<main>
<nav class="tabs-nav sticky top-0 z-50">
    <div onclick="setTab('pericias')" id="tab-pericias" class="tab-btn tab-active">Per√≠cias</div>
    <div onclick="setTab('combate')" id="tab-combate" class="tab-btn">Arsenal</div>
    <div onclick="setTab('habilidades')" id="tab-habilidades" class="tab-btn">Habilidades</div>
    <div onclick="setTab('inventario')" id="tab-inventario" class="tab-btn">Invent√°rio</div>
    <div onclick="setTab('anotacoes')" id="tab-anotacoes" class="tab-btn">Anota√ß√µes</div>
</nav>

<div class="content-area">
    <section id="view-pericias" class="skills-grid"></section>

    <section id="view-combate" class="hidden space-y-6">
        <div class="bg-white/5 p-5 rounded-2xl border border-white/10">
            <h3 class="text-[10px] uppercase font-black text-[var(--accent)] tracking-[0.2em] mb-4">Pool de Dados</h3>
            <div class="flex gap-3">
                <input type="text" id="dice-command" class="bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-sm text-white w-full outline-none focus:border-[var(--accent)] font-mono" placeholder="Ex: 3#d20+INF" onkeydown="if(event.key === 'Enter') playerMasterRoll()">
                <button onclick="playerMasterRoll()" class="bg-[var(--accent)] text-black font-black px-6 rounded-xl text-xs uppercase hover:scale-105 transition">Lan√ßar</button>
            </div>
        </div>
        <div id="combat-list" class="item-list"></div>
        <button onclick="addCombatItem()" class="btn-add">+ VINCULAR NOVA ARMA</button>
    </section>

    <section id="view-habilidades" class="hidden space-y-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-title text-white uppercase italic">Habilidades & Poderes</h2>
        </div>
        <div id="habilidades-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        <button onclick="addHabilidade()" class="btn-add">+ NOVA HABILIDADE</button>
    </section>

    <section id="view-inventario" class="hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-title text-white uppercase italic">Mochila</h2>
            <span id="inv-weight-display" class="text-xs font-mono font-bold text-[var(--accent)] border border-[var(--accent)] px-3 py-1 rounded">PESO: 0 / 0</span>
        </div>
        <div id="inventory-list" class="item-list"></div>
        <button onclick="addInventoryItem()" class="btn-add">+ ADICIONAR ITEM</button>
    </section>

    <section id="view-anotacoes" class="hidden">
        <textarea id="txt-notes" onchange="saveNotes(this.value)" 
            class="w-full h-[75vh] bg-black/20 border border-white/10 rounded-xl p-8 text-gray-300 outline-none resize-none leading-relaxed font-mono text-sm focus:border-[var(--accent)] transition"
            placeholder="Registro de miss√£o..."></textarea>
    </section>
</div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAzDHaOYApynTHqdvhWy4FhUvwLXr5zfuc",
        authDomain: "ciclo-vittae.firebaseapp.com",
        projectId: "ciclo-vittae",
        storageBucket: "ciclo-vittae.firebasestorage.app",
        messagingSenderId: "595476111730",
        appId: "1:595476111730:web:a04d2d53f3d5f9c902fdeb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const charID = localStorage.getItem('ciclo_char_id') || 'amiga';

    let charData = { estado: 'vivo', info: {}, status: {}, atributos: {}, pericias: {}, combate: [], inventario: [], anotacoes: '' };

    const skillsMap = {
        "Acrobacia": "Proje√ß√£o", "Adestramento": "Encantamento", "Atletismo": "Influencia",
        "Atua√ß√£o": "Encantamento", "Cura": "Conhecimento", "Diplomacia": "Encantamento",
        "Engana√ß√£o": "Encantamento", "Fortitude": "Vitalidade", "Furtividade": "Proje√ß√£o",
        "Iniciativa": "Proje√ß√£o", "Intimida√ß√£o": "Encantamento", "Intui√ß√£o": "Espiritualidade",
        "Investiga√ß√£o": "Conhecimento", "Ladinagem": "Proje√ß√£o", "Luta": "Influencia",
        "Misticismo": "Espiritualidade", "Percep√ß√£o": "Proje√ß√£o", "Pilotagem": "Proje√ß√£o",
        "Pontaria": "Proje√ß√£o", "Reflexos": "Proje√ß√£o", "Religi√£o": "Conhecimento",
        "Sobreviv√™ncia": "Conhecimento", "Vontade": "Espiritualidade"
    };

const defaultData = {
    estado: 'vivo',
    info: { profissao: '', idade: '', altura: '' },
    status: {
        Vida: { a: 10, m: 10 },
        Sanidade: { a: 10, m: 10 }
    },
    // Todos os atributos come√ßam em 1
    atributos: {
        Vitalidade: 1, Proje√ß√£o: 1, Conhecimento: 1, 
        Encantamento: 1, Influencia: 1, Espiritualidade: 1
    },
    // B√¥nus de per√≠cias come√ßam em 0
    pericias: Object.keys(skillsMap).reduce((acc, skill) => {
        acc[skill] = { b: 0, t: false };
        return acc;
    }, {}),
    combate: [],
    inventario: [],
    habilidades: [],
    anotacoes: ''
};

    // LOGS E ROLAGEM
    async function logRoll(acao, dados, total) {
        await addDoc(collection(db, "logs_rolagens"), {
            charNome: charData.info.nome || "Desconhecido",
            pericia: acao, dados: dados, total: total, timestamp: Date.now()
        });
    }

async function rollPool(nome, qtdDados, somaFinal) {
    let results = [];
    let resultadoDado = 0;
    
    // Regra de Desvantagem para 0 ou menos
    if (qtdDados <= 0) {
        for (let i = 0; i < 2; i++) results.push(Math.floor(Math.random() * 20) + 1);
        resultadoDado = Math.min(...results);
        nome += " (Desvantagem)";
    } else {
        // Pool normal
        for (let i = 0; i < qtdDados; i++) results.push(Math.floor(Math.random() * 20) + 1);
        resultadoDado = Math.max(...results);
    }

    const totalFinal = resultadoDado + somaFinal;

    await logRoll(nome, results, totalFinal);
    showPopup(nome, totalFinal, results, resultadoDado); 
}

// Rolar ATRIBUTO PURO: (Valor)d20 + ZERO
window.rollAttr = (nome, valor) => {
    rollPool(`Atributo: ${nome}`, valor, 0); 
};

// Rolar PER√çCIA: (Atrib)d20 + Atrib + Treino + Bonus
window.rollCheck = (nome, valorAtrib, bonusSoma) => {
    // Aqui a soma final inclui o pr√≥prio valor do atributo
    rollPool(nome, valorAtrib, (valorAtrib + bonusSoma));
};

    window.rollDamage = async (nomeItem, formula) => {
        const regex = /(\d+)d(\d+)([\+\-]\d+)?/i;
        const match = formula.match(regex);
        let total = 0, results = [];
        
        if (match) {
            const qtd = parseInt(match[1]), faces = parseInt(match[2]);
            const mod = match[3] ? parseInt(match[3]) : 0;
            for(let i=0; i<qtd; i++) { let r = Math.floor(Math.random() * faces) + 1; results.push(r); total += r; }
            total += mod;
            await logRoll(`Dano: ${nomeItem}`, results, total);
            showPopup(`Dano: ${nomeItem}`, total, results, null);
        } else {
            const val = parseInt(formula);
            if(!isNaN(val)) { await logRoll(`Dano: ${nomeItem}`, [], val); showPopup(nomeItem, val, [], null); }
        }
    };

    function showPopup(titulo, total, dados, dadoBase) {
        const container = document.getElementById('pop-container');
        const el = document.createElement('div');
        el.className = 'pop-card';
        let colorClass = 'text-white';
        if(dadoBase === 20) colorClass = 'crit-gold';
        if(dadoBase === 1) colorClass = 'crit-blue';

        el.innerHTML = `
            <div class="text-[9px] uppercase font-bold text-white/40 tracking-wider mb-1">${titulo}</div>
            <div class="text-4xl font-black italic ${colorClass}">${total}</div>
            ${dados.length > 0 ? `<div class="text-[10px] font-mono mt-2 text-white/20">Dados: [${dados.join(', ')}]</div>` : ''}
        `;
        container.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 4000);
    }

    // --- NOVA L√ìGICA DE STATUS AUTOM√ÅTICO ---
    function recalculateStats() {
        const getAttr = (n) => parseFloat(charData.atributos[n]) || 0;
        const vit = getAttr("Vitalidade");
        const inf = getAttr("Influencia");
        const con = getAttr("Conhecimento");

        let vidaMax = 10;
        
        // F√ìRMULA DE VIDA
        if (charData.estado === 'vivo') {
            vidaMax = (vit + inf) + (vit * inf) + 5;
        } else {
            vidaMax = (vit + con) + (vit * con) + 5;
        }

        // Verifica se mudou para evitar loop infinito de updates
        const currentMax = charData.status?.Vida?.m;
        if (vidaMax !== currentMax) {
            // Mant√©m a vida atual (a), muda a m√°xima (m)
            const vidaAtual = charData.status?.Vida?.a || 10;
            updateDoc(doc(db, "personagens", charID), { 'status.Vida': { a: vidaAtual, m: vidaMax } });
        }
    }

    // RENDERIZA√á√ÉO
    function renderAll() {
    document.body.className = `tema-${charData.estado}`;
    document.getElementById('char-name-display').innerText = charData.info.nome || "SEM NOME";
    document.getElementById('char-state-display').innerText = charData.estado.toUpperCase();
    
    // Adicionado 'profissao' na lista abaixo:
    ['nome', 'profissao', 'idade', 'altura'].forEach(k => {
        const el = document.getElementById(`inp-${k}`);
        if (el) el.value = charData.info[k] || "";
    });

    renderBars();
    renderAttrs();
    renderSkills();
    renderCombat();
    renderInventory();
    renderHabilidades(); 
    renderAnotacoes();
}

function renderBars() {
        const bars = charData.estado === 'vivo' ? ['Vida', 'Sanidade'] : ['Vida', 'Metaf√≠sica', 'Opacidade'];
        const colors = { 'Vida': '#ef4444', 'Sanidade': '#3b82f6', 'Metaf√≠sica': '#a855f7', 'Opacidade': '#10b981' };
        
        document.getElementById('bars-container').innerHTML = bars.map(k => {
            const v = charData.status[k] || { a: 10, m: 10 };
            const pct = Math.min(100, Math.max(0, (v.a / v.m) * 100));
            return `
            <div class="progress-container">
                <div class="flex justify-between text-[9px] font-bold uppercase tracking-wider text-white/60"><span>${k}</span><span>${v.a} / ${v.m}</span></div>
                <div class="progress-bg">
                    <div class="progress-fill" style="width: ${pct}%; background: ${colors[k]}"></div>
                    <div class="progress-inputs flex justify-between">
                        <div class="flex">
                            <button class="bar-btn" onclick="modStatus('${k}', -5)">-5</button>
                            <button class="bar-btn" onclick="modStatus('${k}', -1)">-1</button>
                        </div>
                        
                        <div class="flex-1"></div>

                        <div class="flex border-l border-white/10">
                            <button class="bar-btn" onclick="modStatus('${k}', 1)">+1</button>
                            <button class="bar-btn" onclick="modStatus('${k}', 5)">+5</button>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

function renderAttrs() {
    let currentAttrs = ["Vitalidade", "Proje√ß√£o", "Conhecimento", "Encantamento", "Influencia"];
    if (charData.estado === 'morto') currentAttrs.push("Espiritualidade");

    document.getElementById('attrs-list').innerHTML = currentAttrs.map(attr => {
        const val = charData.atributos[attr] || 0;
        return `
        <div class="flex justify-between items-center bg-white/5 px-3 py-2 rounded border border-white/5 hover:border-[var(--accent)] transition-all group">
            <span onclick="rollAttr('${attr}', ${val})" class="text-[10px] font-bold uppercase text-white/50 tracking-wider cursor-pointer hover:text-[var(--accent)] transition-colors">
                ${attr} üé≤
            </span>
            <div class="flex items-center gap-2">
                <button onclick="changeVal('atributos.${attr}', -1)" class="ctrl-btn">-</button>
                <input type="number" value="${val}" readonly
                    class="bg-transparent text-center text-white font-bold w-6 outline-none text-xs">
                <button onclick="changeVal('atributos.${attr}', 1)" class="ctrl-btn">+</button>
            </div>
        </div>`;
    }).join('');
}

function renderSkills() {
    document.getElementById('view-pericias').innerHTML = Object.keys(skillsMap).map(skill => {
        const attrKey = skillsMap[skill];
        const attrVal = charData.atributos[attrKey] || 0;
        const skillData = (charData.pericias && charData.pericias[skill]) || { b: 0, t: false };
        
        // Treinamento (+2) e B√¥nus de campo
        const treino = skillData.t ? 2 : 0;
        const bonusExtra = parseFloat(skillData.b) || 0;
        const somaSemAtributo = treino + bonusExtra;

        return `
        <div class="skill-card">
            <div class="skill-top">
                <div>
                    <div class="skill-name">${skill}</div>
                    <div class="skill-attr text-[var(--accent)]">${attrKey.substring(0,3)}</div>
                </div>
                <div class="skill-val text-[10px] opacity-60">
                    ${attrVal}d20 + ${attrVal + somaSemAtributo}
                </div>
            </div>
            
            <div class="flex gap-2 items-center mt-2 bg-black/20 p-1 rounded">
    <input type="checkbox" ${skillData.t ? 'checked' : ''} onchange="saveSkill('${skill}', 't', this.checked)" class="accent-[var(--accent)] w-3 h-3 cursor-pointer">
    <span class="text-[9px] uppercase opacity-40 font-bold">Treino</span>
    <div class="flex items-center gap-1 ml-auto">
        <button onclick="changeVal('pericias.${skill}.b', -1)" class="ctrl-btn" style="width:14px; height:14px;">-</button>
        <input type="number" value="${skillData.b}" readonly 
            class="bg-transparent text-center text-[10px] text-white/70 w-6 outline-none font-mono">
        <button onclick="changeVal('pericias.${skill}.b', 1)" class="ctrl-btn" style="width:14px; height:14px;">+</button>
    </div>
</div>
            <button onclick="rollCheck('${skill}', ${attrVal}, ${somaSemAtributo})" class="btn-roll mt-2">
                Rolar
            </button>
        </div>`;
    }).join('');
}

function renderCombat() {
    const list = document.getElementById('combat-list');
    list.innerHTML = '';
    
    (charData.combate || []).forEach((item, idx) => {
        const el = document.createElement('div');
        el.className = 'bg-white/5 border border-white/10 p-4 rounded-xl flex flex-col md:flex-row gap-4 items-center group';
        
        // L√≥gica de Dano: Se corpo-a-corpo, mostra o b√¥nus de influ√™ncia
        const influ = charData.atributos.Influencia || 0;
        const infoDano = item.tipo === 'corpo' ? `${item.dano} + ${influ} (Influ)` : item.dano;
        
        // Pega o valor da per√≠cia selecionada para rolar o ataque
        const attrDaPericia = skillsMap[item.pericia] || "Influencia";
        const valorAtrib = charData.atributos[attrDaPericia] || 0;

        el.innerHTML = `
            <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-3 w-full">
                <input value="${item.nome}" onchange="updateCombat(${idx}, 'nome', this.value)" class="bg-transparent font-bold text-sm outline-none text-white" placeholder="Nome">
                
                <select onchange="updateCombat(${idx}, 'pericia', this.value)" class="bg-black/20 text-[10px] uppercase font-bold p-2 rounded outline-none text-white/60">
                    ${Object.keys(skillsMap).map(s => `<option value="${s}" ${item.pericia === s ? 'selected' : ''}>${s}</option>`).join('')}
                </select>

                <div class="flex gap-2">
                    <select onchange="updateCombat(${idx}, 'tipo', this.value)" class="bg-black/20 text-[10px] uppercase font-bold p-2 rounded outline-none text-white/40">
                        <option value="corpo" ${item.tipo === 'corpo' ? 'selected' : ''}> Corpo</option>
                        <option value="distancia" ${item.tipo === 'distancia' ? 'selected' : ''}> Dist√¢ncia</option>
                    </select>
                    <input value="${item.dano}" onchange="updateCombat(${idx}, 'dano', this.value)" class="bg-black/20 text-center font-mono text-xs p-2 rounded w-full outline-none text-emerald-400" placeholder="Ex: 1d8">
                </div>
            </div>
            
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="rollCheck('Ataque: ${item.nome}', ${valorAtrib}, 0)" class="flex-1 md:flex-none bg-[var(--accent)] text-black font-black text-[10px] px-4 py-2 rounded uppercase">Ataque</button>
                <button onclick="executarDano('${item.nome}', '${item.dano}', '${item.tipo}')" class="flex-1 md:flex-none border border-[var(--accent)] text-[var(--accent)] font-black text-[10px] px-4 py-2 rounded uppercase">Dano</button>
                <button onclick="removeCombat(${idx})" class="text-red-500/30 hover:text-red-500 transition px-2">‚úï</button>
            </div>
        `;
        list.appendChild(el);
    });
}

function renderHabilidades() {
    const container = document.getElementById('habilidades-list');
    const habs = charData.habilidades || [];
    
    container.innerHTML = habs.map((hab) => `
        <div class="hab-card flex flex-col gap-2 p-4 bg-white/5 rounded-xl border border-white/10">
            <div class="flex justify-between items-start">
                <input type="text" 
                    value="${hab.nome || ''}" 
                    onchange="updateHab('${hab.id}', 'nome', this.value)" 
                    class="bg-transparent font-bold text-[var(--accent)] outline-none w-full uppercase"
                    placeholder="NOME DA HABILIDADE...">
                <button onclick="removeHab('${hab.id}')" class="text-red-500/50 hover:text-red-500 transition ml-2">‚úï</button>
            </div>
            <textarea 
                onchange="updateHab('${hab.id}', 'desc', this.value)" 
                class="bg-transparent text-xs text-white/60 outline-none resize-none h-20"
                placeholder="Escreva a descri√ß√£o aqui...">${hab.desc || ''}</textarea>
        </div>
    `).join('');
}


// Fun√ß√£o para atualizar e salvar no Firebase

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        list.innerHTML = '';
        let totalWeight = 0;

        (charData.inventario || []).forEach((item, idx) => {
            const peso = parseFloat(item.peso) || 1;
            const qtd = parseFloat(item.qtd) || 1;
            totalWeight += (peso * qtd);

            const el = document.createElement('div');
            el.className = 'item-row';
            el.innerHTML = `
                <input value="${item.nome}" onchange="updateInv(${idx}, 'nome', this.value)" class="input-glass text-sm font-bold" placeholder="Item">
                <input type="number" value="${item.qtd}" onchange="updateInv(${idx}, 'qtd', this.value)" class="input-glass text-sm text-center font-mono" placeholder="Qtd">
                <input type="number" value="${item.peso}" onchange="updateInv(${idx}, 'peso', this.value)" class="input-glass text-sm text-center font-mono" placeholder="Kg">
                <button onclick="removeInv(${idx})" class="btn-icon">√ó</button>
            `;
            list.appendChild(el);
        });

        // Calculo de Carga (Influencia * 3)
        const influencia = parseFloat(charData.atributos['Influencia']) || 0;
        const maxWeight = influencia * 3;
        const weightDisplay = document.getElementById('inv-weight-display');
        weightDisplay.innerText = `PESO: ${totalWeight.toFixed(1)} / ${maxWeight}`;
        
        if(totalWeight > maxWeight) {
            weightDisplay.className = "text-xs font-mono font-bold text-overload border border-red-500 px-3 py-1 rounded bg-red-900/20";
            weightDisplay.innerText += " [SOBRECARGA]";
        } else {
            weightDisplay.className = "text-xs font-mono font-bold text-[var(--accent)] border border-[var(--accent)] px-3 py-1 rounded";
        }
    }

    // No seu HTML ou fun√ß√£o de renderiza√ß√£o das anota√ß√µes
function renderAnotacoes() {
    const area = document.getElementById('view-anotacoes');
    area.innerHTML = `
        <h2 class="text-xl font-title text-white uppercase italic mb-4">Di√°rio de Bordo</h2>
        <textarea id="txt-notes" 
            onchange="saveAnotacoes(this.value)"
            class="w-full h-[60vh] bg-white/5 border border-white/10 rounded-2xl p-6 text-sm text-white/80 outline-none focus:border-[var(--accent)] transition resize-none"
            placeholder="Escreva suas descobertas aqui...">${charData.anotacoes || ''}</textarea>
    `;
}

// --- L√ìGICA DE DANO COM SOMA AUTOM√ÅTICA ---
window.executarDano = async (nome, formula, tipo) => {
    const influ = charData.atributos.Influencia || 0;
    const somaExtra = tipo === 'corpo' ? influ : 0;
    
    const regex = /(\d+)d(\d+)([\+\-]\d+)?/i;
    const match = formula.match(regex);
    
    let totalDados = 0, resultados = [];
    
    if (match) {
        const qtd = parseInt(match[1]), faces = parseInt(match[2]);
        const modFormula = match[3] ? parseInt(match[3]) : 0;
        
        for(let i=0; i<qtd; i++) {
            let r = Math.floor(Math.random() * faces) + 1;
            resultados.push(r);
            totalDados += r;
        }
        
        const totalFinal = totalDados + modFormula + somaExtra;
        await logRoll(`Dano: ${nome}`, resultados, totalFinal);
        showPopup(`Dano: ${nome}`, totalFinal, resultados, null);
    }
};

// --- AJUSTE NO UPDATE DE COMBATE ---
window.addCombatItem = () => {
    const novo = { nome: 'Nova Arma', pericia: 'Luta', dano: '1d6', tipo: 'corpo' };
    updateDoc(doc(db, "personagens", charID), { 
        combate: [...(charData.combate || []), novo] 
    });
};

    // --- CONSOLE DE DADOS (ESTILO MESTRE COM LOG) ---
window.playerMasterRoll = async () => {
    const commandInput = document.getElementById('dice-command');
    let command = commandInput.value.trim();
    if (!command) return;

    // Criamos um mapa de substitui√ß√£o para facilitar
    const substituticoes = {
        'INF': charData.atributos.Influencia || 0,
        'CON': charData.atributos.Conhecimento || 0,
        'VIT': charData.atributos.Vitalidade || 0,
        'PRO': charData.atributos.Proje√ß√£o || 0,
        'ENC': charData.atributos.Encantamento || 0,
        'ESP': charData.atributos.Espiritualidade || 0
    };

    // Substitui todas as ocorr√™ncias, independente de ser mai√∫scula ou min√∫scula
    for (const [chave, valor] of Object.entries(substituticoes)) {
        const regex = new RegExp(chave, 'gi'); 
        command = command.replace(regex, valor);
    }

    // Regex para capturar: [quantidade][modificador # ou $]d[faces][+ ou -][soma]
    const regexDados = /^(\d+)?([#$])?d(\d+)([+-].+)?$/i;
    const match = command.match(regexDados);

    if (!match) { 
        alert("Comando Inv√°lido! Use ex: 3#d20+INF"); 
        return; 
    }

    let qtd = parseInt(match[1]) || 1;
    let mod = match[2]; 
    let faces = parseInt(match[3]);
    
    // O eval aqui resolve contas complexas como +5+2 que podem vir das substitui√ß√µes
    let soma = 0;
    if (match[4]) {
        try {
            soma = eval(match[4]);
        } catch (e) {
            soma = 0;
        }
    }

    let resultados = [];
    for (let i = 0; i < qtd; i++) {
        resultados.push(Math.floor(Math.random() * faces) + 1);
    }

    let escolhido = mod === '#' ? Math.max(...resultados) : (mod === '$' ? Math.min(...resultados) : resultados.reduce((a, b) => a + b, 0));
    let totalFinal = escolhido + soma;

    // Envia para o log do mestre
    await logRoll(`Console: ${commandInput.value}`, resultados, totalFinal);
    showPopup(`Console: ${commandInput.value}`, totalFinal, resultados, escolhido);
    
    commandInput.value = '';
};

    // --- FUN√á√ïES DE UPDATE ---
    window.saveInfo = (k, v) => updateDoc(doc(db, "personagens", charID), { [`info.${k}`]: v });
    window.saveNotes = (v) => updateDoc(doc(db, "personagens", charID), { anotacoes: v });
    window.updateHab = (id, campo, valor) => {
    const lista = charData.habilidades.map(h => h.id === id ? {...h, [campo]: valor} : h);
    updateDoc(doc(db, "personagens", charID), { habilidades: lista });
};
    window.modStatus = async (key, delta) => {
        const cur = charData.status[key] || { a: 10, m: 10 };
        const novo = Math.min(cur.m, Math.max(0, cur.a + delta));
        await updateDoc(doc(db, "personagens", charID), { [`status.${key}.a`]: novo });
    };

    window.saveAttr = (attr, val) => {
        updateDoc(doc(db, "personagens", charID), { [`atributos.${attr}`]: parseFloat(val) })
        .then(() => recalculateStats()); // RECALCULA VIDA QUANDO MUDA ATRIBUTO
    };
    
    window.saveSkill = (s, f, v) => updateDoc(doc(db, "personagens", charID), { [`pericias.${s}.${f}`]: f==='t'?v:parseFloat(v) });
    
    window.toggleEstado = () => {
        const novo = charData.estado === 'vivo' ? 'morto' : 'vivo';
        updateDoc(doc(db, "personagens", charID), { estado: novo })
        .then(() => recalculateStats()); // RECALCULA VIDA QUANDO MUDA ESTADO
    };

    window.saveAnotacoes = (valor) => {
        updateDoc(doc(db, "personagens", charID), { anotacoes: valor });
    };

    window.changeVal = async (path, delta) => {
    // Separa o caminho (ex: "atributos.Vitalidade" vira ["atributos", "Vitalidade"])
    const parts = path.split('.');
    let currentVal = 0;

    if (parts.length === 2) {
        currentVal = parseFloat(charData[parts[0]][parts[1]]) || 0;
    } else if (parts.length === 3) {
        currentVal = parseFloat(charData[parts[0]][parts[1]][parts[2]]) || 0;
    }

    const newVal = currentVal + delta;
    
    // Salva no Firebase
    await updateDoc(doc(db, "personagens", charID), { [path]: newVal });
    
    // Se for atributo, recalcula a vida
    if (parts[0] === 'atributos') recalculateStats();
};
    
// --- L√ìGICA DE HABILIDADES ---
window.addHabilidade = () => {
    const nova = { id: String(Date.now()), nome: '', desc: '' };
    updateDoc(doc(db, "personagens", charID), { 
        habilidades: [...(charData.habilidades || []), nova] 
    });
};

// Remove sem aviso
window.removeHab = (id) => {
    const lista = (charData.habilidades || []).filter(h => h.id !== id);
    updateDoc(doc(db, "personagens", charID), { habilidades: lista });
};

// Atualiza√ß√£o gen√©rica
window.updateHab = (id, campo, valor) => {
    const lista = (charData.habilidades || []).map(h => 
        h.id === id ? { ...h, [campo]: valor } : h
    );
    updateDoc(doc(db, "personagens", charID), { habilidades: lista });
};

    // COMBAT & INV HELPERS
    window.updateCombat = (i, f, v) => { let l=[...charData.combate]; l[i][f]=v; updateDoc(doc(db,"personagens",charID), {combate:l}); };
    window.removeCombat = (i) => { let l=[...charData.combate]; l.splice(i,1); updateDoc(doc(db,"personagens",charID), {combate:l}); };

    window.addInventoryItem = () => updateDoc(doc(db, "personagens", charID), { inventario: [...(charData.inventario||[]), {nome:'Novo Item', qtd:1, peso:1}] });
    window.updateInv = (i, f, v) => { let l=[...charData.inventario]; l[i][f]=v; updateDoc(doc(db,"personagens",charID), {inventario:l}); };
    window.removeInv = (i) => { let l=[...charData.inventario]; l.splice(i,1); updateDoc(doc(db,"personagens",charID), {inventario:l}); };

window.setTab = (t) => {
    // Remove a classe ativa de todos os bot√µes
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
    // Adiciona ao bot√£o clicado
    document.getElementById(`tab-${t}`).classList.add('tab-active');
    
    // Lista de todas as se√ß√µes de conte√∫do
    const tabs = ['pericias', 'combate', 'habilidades', 'inventario', 'anotacoes'];
    
    tabs.forEach(x => {
        const el = document.getElementById(`view-${x}`);
        if (el) {
            if (x === t) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }
    });
};

onSnapshot(doc(db, "personagens", charID), async (snap) => {
    if (snap.exists()) { 
        charData = { ...charData, ...snap.data() }; 
        renderAll();
    } else {
        // Se a ficha n√£o existir, usamos setDoc para criar o documento com os padr√µes
        console.log("Criando nova ficha com valores padr√£o...");
        try {
            await setDoc(doc(db, "personagens", charID), defaultData);
        } catch (e) {
            console.error("Erro ao criar ficha: ", e);
        }
    }
});
</script>
</body>
</html>